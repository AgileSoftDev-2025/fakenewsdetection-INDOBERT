from fastapi import APIRouter, HTTPException, Response
from pydantic import BaseModel
from typing import Optional
import json, uuid, logging
from pathlib import Path
from datetime import datetime
import io
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib import colors
# ----------------------------------

router = APIRouter(tags=["results"])
logger = logging.getLogger(__name__)

# Buat folder untuk nyimpen hasil
RESULTS_DIR = Path("data/shared_results")
RESULTS_DIR.mkdir(parents=True, exist_ok=True)


class ResultCreate(BaseModel):
    title: Optional[str] = None
    text: str
    prediction: int
    prob_hoax: float
    model_version: str
    extracted_text: Optional[str] = None


class ResultResponse(BaseModel):
    id: str
    # ✅ HAPUS field "url" - biar frontend yang generate


class ResultDetail(BaseModel):
    id: str
    title: Optional[str]
    text: str
    prediction: int
    prob_hoax: float
    model_version: str
    extracted_text: Optional[str]
    created_at: str


class PDFRequest(BaseModel):
    title: str
    content: str
    prediction: str
    confidence: str
    date: str


# -----------------------------------------


@router.post("/results", response_model=ResultResponse)
async def create_shared_result(data: ResultCreate):
    # ... (Logika asli Anda tetap di sini) ...
    """Simpan hasil analisis dan return ID"""
    result_id = str(uuid.uuid4())[:12]

    result_data = {
        "id": result_id,
        "title": data.title,
        "text": data.text,
        "prediction": data.prediction,
        "prob_hoax": data.prob_hoax,
        "model_version": data.model_version,
        "extracted_text": data.extracted_text,
        "created_at": datetime.now().isoformat(),
    }

    # Simpan ke file JSON
    result_file = RESULTS_DIR / f"{result_id}.json"
    with open(result_file, "w", encoding="utf-8") as f:
        json.dump(result_data, f, ensure_ascii=False, indent=2)

    logger.info(f"✅ Saved result with ID: {result_id}")

    # ✅ Return cuma ID, URL dibuat di frontend
    return {"id": result_id}


@router.get("/results/{result_id}", response_model=ResultDetail)
async def get_shared_result(result_id: str):
    """Ambil hasil analisis berdasarkan ID"""
    result_file = RESULTS_DIR / f"{result_id}.json"

    if not result_file.exists():
        logger.warning(f"❌ Result not found: {result_id}")
        raise HTTPException(status_code=404, detail="Result not found")

    logger.info(f"✅ Fetched result: {result_id}")

    with open(result_file, "r", encoding="utf-8") as f:
        return json.load(f)


@router.post("/generate-pdf")
async def generate_pdf_endpoint(data: PDFRequest):
    """Endpoint khusus untuk download PDF langsung dari data Frontend"""
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    # Header
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, height - 50, "LAPORAN DETEKSI BERITA")
    c.setFont("Helvetica", 10)
    c.drawString(50, height - 65, "Generated by FakeNews Detection System")
    c.line(50, height - 75, width - 50, height - 75)

    # Info Utama
    y = height - 100
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y, "HASIL ANALISIS:")

    # Warna teks status
    c.setFont("Helvetica-Bold", 14)
    if "VALID" in data.prediction.upper() or "FAKTA" in data.prediction.upper():
        c.setFillColor(colors.green)
    else:
        c.setFillColor(colors.red)
    c.drawString(160, y, data.prediction)
    c.setFillColor(colors.black)  # Reset warna

    y -= 25
    c.setFont("Helvetica", 12)
    c.drawString(50, y, f"Confidence: {data.confidence}")
    y -= 20
    c.drawString(50, y, f"Tanggal: {data.date}")

    # Judul
    y -= 40
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y, "Judul:")
    y -= 15
    c.setFont("Helvetica", 11)
    c.drawString(50, y, data.title[:90] + ("..." if len(data.title) > 90 else ""))

    # Konten
    y -= 30
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y, "Konten / Cuplikan:")
    y -= 20
    c.setFont("Helvetica", 10)

    # Simple Text Wrapping
    text_object = c.beginText(50, y)
    words = data.content.replace("\n", " ").split()
    current_line = ""
    for word in words:
        if c.stringWidth(current_line + " " + word, "Helvetica", 10) < (width - 100):
            current_line += " " + word
        else:
            text_object.textLine(current_line)
            y -= 12
            current_line = word
            # Pindah halaman jika penuh
            if y < 50:
                c.drawText(text_object)
                c.showPage()
                c.setFont("Helvetica", 10)
                text_object = c.beginText(50, height - 50)
                y = height - 50
    text_object.textLine(current_line)
    c.drawText(text_object)

    c.save()
    buffer.seek(0)

    return Response(content=buffer.getvalue(), media_type="application/pdf")
